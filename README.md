# Randomized testing for checking Byzantine fault-tolerance of `pbft-java`

This repository contains the implementation of Byzzfuzz testing algorithm for testing the implementation of Practical Byzantine Fault Tolerance (PBFT) emulator built in Java. 

You can access the repository for the PBFT implementation under test [here](https://github.com/caojohnny/pbft-java).

Our tester implementation intercepts the exchanged messages in the system using [TesterTransport](example/src/main/java/edu/tudelft/serg/TesterTransport.java) and injects network and Byzantine process faults using [FaultInjector](example/src/main/java/edu/tudelft/serg/FaultInjector.java).


## Building and running the PBFT cluster: 

To run the system, first start the redis-server that is used by the PBFT processes. You can download and run the redis server using [redis github repository](https://github.com/redis/redis). We tested the system using redis version 6.2.1.


``` shell
cd /path/to/redis/server/src
./redis-server
```

After you started the redis server, you can build and run the system using the command below:

``` shell
cd /path/to/pbft-java/
mvn clean install
java -cp example/target/pbft-java-example-jar-with-dependencies.jar com.gmail.woodyc40.pbft.Main
```

This starts a test execution with a cluster of processes running the PBFT protocol and it submits two client requests to be executed by the cluster.  The current configuration runs a test with a randomly generated configuration. 

You can use `test.conf` to configure the test parameters (the number of protocol rounds with network faults, the number of protocol rounds with process faults, the number of rounds among which to inject faults) and test options (e.g., the random seed to reproduce a test execution, the timeout for processing a client request, the timeout for bounded liveness detection, etc).

Alternatively, you can execute a test execution from a given fault configuration providing the json string for the fault configuration (see the example fault configurations in [TesterTransport.java](example/src/main/java/edu/tudelft/serg/TesterTransport.java)). 


## Example test executions:

We use Byzfuzz to test the example PBFT application provided by the [implementation under test](https://github.com/caojohnny/pbft-java). The example runs a cluster of four processes (with process ids 0, 1, 2, 3) that serve client requests for some arithmetic operations. We submit two client operations (to process `operation=AddOp{first=1, second=1}` and `operation=AddOp{first=2, second=2}`) to the system. The cluster runs PBFT to agree on their logs of issued client operations.


Given the number of rounds with network faults (`d`), the number of rounds with process faults (`c`), and the number of rounds (`r`) to distribute the faults as test parameters, Byzzfuzz randomly generates a test execution that injects `d` random network and `c` random process faults into the execution. Alternatively, it can enforce the execution of a given fault configuration of which faults in inject in which rounds. 

Here we provide two example test executions one of which randomly generates a test execution using the test parameters, and another one injects faults from a given fault configuration.

### Running a randomly generated test execution for a given set of test parameters:

To run a randomly generated test execution, initialize the fault injector in the `TesterTransport` using the configuration read from `test.conf`. See line 37 in [TesterTransport.java](example/src/main/java/edu/tudelft/serg/TesterTransport.java):

```
faultInjector = new FaultInjector(conf);
```

Here is an example output of a randomly generated test execution:

```
Random test generation using the configuration in test.conf
Test inputs: d = 1, c = 1, r = 8
Network and process faults are generated by using random seed: 12345151
{"byzantineReplicaId":3,"networkFaults":[{"round":4,"partition":[[3],[1,2],[0]]}],"msgCorruptions":[{"round":6,"receivers":[0,1],"corruptionType":428240996}],"smallScope":true}

Sent: 0 -> 1 {"type":"PRE-PREPARE","view-number":0,"seq-number":0,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} ##1
Sent: 0 -> 2 {"type":"PRE-PREPARE","view-number":0,"seq-number":0,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} ##1
Sent: 0 -> 3 {"type":"PRE-PREPARE","view-number":0,"seq-number":0,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} ##1
Sent: 3 -> 0 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":3} ##2
Sent: 3 -> 1 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":3} ##2
Sent: 3 -> 2 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":3} ##2
Sent: 2 -> 0 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##2
Sent: 2 -> 1 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##2
Sent: 2 -> 3 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##2
Sent: 1 -> 0 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##2
Sent: 1 -> 2 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##2
Sent: 1 -> 3 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##2
Sent: 2 -> 0 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##3
Sent: 2 -> 1 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##3
Sent: 2 -> 3 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##3
Sent: 3 -> 0 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":3} ##3
Sent: 3 -> 1 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":3} ##3
Sent: 3 -> 2 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":3} ##3
Sent: 0 -> 1 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":0} ##3
Sent: 0 -> 2 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":0} ##3
Sent: 0 -> 3 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":0} ##3
Sent reply: 2 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":2,"result":2} ##4
Sent reply: 3 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":3,"result":2} ##4
Sent: 1 -> 0 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##3
Sent: 1 -> 2 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##3
Sent: 1 -> 3 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##3
LOG-Replica-Commit:3 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
LOG-Replica-Commit:2 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
Sent reply: 0 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":0,"result":2} ##4
LOG-Replica-Commit:0 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
=========== COMPLETED ===============
1 + 1 = 2
==========================
Sent reply: 1 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":1,"result":2} ##4
LOG-Replica-Commit:1 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
Sent: 0 -> 1 {"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":2,"second":2},"timestamp":1,"client":"client-0"} ##5
Sent: 0 -> 2 {"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":2,"second":2},"timestamp":1,"client":"client-0"} ##5
Sent: 0 -> 3 {"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":2,"second":2},"timestamp":1,"client":"client-0"} ##5
Sent: 3 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
     - Omitted: 3 -> 0{"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} #6
Sent: 3 -> 1 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
     - Omitted: 3 -> 1{"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} #6
Sent: 3 -> 2 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 2 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##6
Sent: 2 -> 1 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##6
Sent: 2 -> 3 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##6
Sent: 1 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##6
Sent: 1 -> 2 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##6
Sent: 1 -> 3 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##6
Sent: 0 -> 1 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":0} ##7
Sent: 0 -> 2 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":0} ##7
Sent: 0 -> 3 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":0} ##7
Sent: 2 -> 0 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 2 -> 1 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 2 -> 3 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 3 -> 0 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##7
Sent: 3 -> 1 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##7
Sent: 3 -> 2 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##7
Sent reply: 2 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":2,"result":4} ##8
LOG-Replica-Commit:2 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Sent reply: 0 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":0,"result":4} ##8
LOG-Replica-Commit:0 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Sent: 1 -> 0 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 1 -> 2 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 1 -> 3 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent reply: 3 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":3,"result":4} ##8
=========== COMPLETED ===============
2 + 2 = 4
==========================
Sent reply: 1 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":1,"result":4} ##8
LOG-Replica-Commit:3 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
LOG-Replica-Commit:1 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Task completed.
```


### Running an example test execution from a given fault configuration:

To run an execution with a specific fault configuration, initialize the fault injector in the `TesterTransport` using json string for the fault configuration. For an example, uncomment the lines 41-42 in [TesterTransport.java](example/src/main/java/edu/tudelft/serg/TesterTransport.java):

```
FaultSetting faultSetting = FaultSetting.readJson(detectsAgreementViolation);
faultInjector = new FaultInjector(faultSetting);
```

Here is an example output of running a given fault configuration:

```
Test generation using the given fault setting.
{"byzantineReplicaId":0,"networkFaults":[],"msgCorruptions":[{"round":1,"receivers":[3],"corruptionType":6}],"smallScope":true}

Sent: 0 -> 1 {"type":"PRE-PREPARE","view-number":0,"seq-number":0,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} ##1
Sent: 0 -> 2 {"type":"PRE-PREPARE","view-number":0,"seq-number":0,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} ##1
Sent: 0 -> 3 {"type":"PRE-PREPARE","view-number":0,"seq-number":0,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} ##1
     - Mutated: 0 -> 3{"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":1,"second":1},"timestamp":0,"client":"client-0"} #1
Sent: 3 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 3 -> 1 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 3 -> 2 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 2 -> 0 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##6
Sent: 2 -> 1 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##6
Sent: 2 -> 3 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##6
Sent: 1 -> 0 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##6
Sent: 1 -> 2 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##6
Sent: 1 -> 3 {"type":"PREPARE","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##6
Sent: 2 -> 0 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##6
Sent: 2 -> 1 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##6
Sent: 2 -> 3 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":2} ##6
Sent: 0 -> 1 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":0} ##6
Sent: 0 -> 2 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":0} ##6
Sent: 0 -> 3 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":0} ##6
Sent: 1 -> 0 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##6
Sent: 1 -> 2 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##6
Sent: 1 -> 3 {"type":"COMMIT","view-number":0,"seq-number":0,"digest":"","replica-id":1} ##6
Sent reply: 0 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":0,"result":2} ##7
Sent reply: 2 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":2,"result":2} ##7
Sent reply: 1 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":1,"result":2} ##7
=========== COMPLETED ===============
1 + 1 = 2
==========================
LOG-Replica-Commit:0 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
LOG-Replica-Commit:1 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
LOG-Replica-Commit:2 	viewNo: 0 	seqNo: 0 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
Sent: 0 -> 1 {"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":2,"second":2},"timestamp":1,"client":"client-0"} ##7
Sent: 0 -> 2 {"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":2,"second":2},"timestamp":1,"client":"client-0"} ##7
Sent: 0 -> 3 {"type":"PRE-PREPARE","view-number":0,"seq-number":1,"digest":"","operation":{"first":2,"second":2},"timestamp":1,"client":"client-0"} ##7
Sent: 3 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 3 -> 1 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 3 -> 2 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##6
Sent: 2 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 2 -> 1 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 2 -> 3 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 1 -> 0 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 1 -> 2 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 1 -> 3 {"type":"PREPARE","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 2 -> 0 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 2 -> 1 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 2 -> 3 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":2} ##7
Sent: 3 -> 0 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##7
Sent: 3 -> 1 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##7
Sent: 3 -> 2 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":3} ##7
Sent: 0 -> 1 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":0} ##7
Sent: 0 -> 2 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":0} ##7
Sent: 0 -> 3 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":0} ##7
Sent reply: 3 -> Client {"type":"REPLY","view-number":0,"timestamp":0,"client-id":"client-0","replica-id":3,"result":2} ##8
Sent reply: 2 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":2,"result":4} ##8
LOG-Replica-Commit:3 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=1, second=1}, timestamp=0, clientId='client-0'}
LOG-Replica-Commit:2 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Sent: 1 -> 0 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 1 -> 2 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Sent: 1 -> 3 {"type":"COMMIT","view-number":0,"seq-number":1,"digest":"","replica-id":1} ##7
Violation of AGREEMENT at Replica: 2 at: LOG-Replica-Commit:2 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Sent reply: 0 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":0,"result":4} ##8
LOG-Replica-Commit:0 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Sent reply: 1 -> Client {"type":"REPLY","view-number":0,"timestamp":1,"client-id":"client-0","replica-id":1,"result":4} ##8
LOG-Replica-Commit:1 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
=========== COMPLETED ===============
2 + 2 = 4
==========================
Violation of AGREEMENT at Replica: 1 at: LOG-Replica-Commit:1 	viewNo: 0 	seqNo: 1 	request: DRRequest{operation=AddOp{first=2, second=2}, timestamp=1, clientId='client-0'}
Task completed.
```

The execution violates agreement since the logs of the correct processes (or replicas) for issuing the client request `DRRequest{operation=AddOp{first=2, second=2}` diverge. The correct processes 1 and 2 issue the operation at `timestamp:1` while the process 3 issues it in `timestamp:0`, for which it could not complete processing the request due to the incorrect message sent by the Byzantine process p0.



## Additional Notes:

The repository will be made available with a more comprehensive list of instructions to run and reuse the artifact.